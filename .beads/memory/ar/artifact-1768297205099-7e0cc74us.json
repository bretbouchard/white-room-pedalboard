{
  "id": "artifact-1768297205099-7e0cc74us",
  "type": "pattern",
  "content": "# SQLAlchemy Telemetry Models Pattern\n\n## Problem\nNeed to store UI and parameter telemetry data in PostgreSQL for analytics and optimization.\n\n## Solution: SQLAlchemy ORM with Async PostgreSQL\n\n### Architecture\n- **BaseModel**: Abstract base class with UUID, created_at, updated_at\n- **Telemetry Models**: UISession, UIInteractionEvent, UIControlMetrics, ParameterChangeEvent\n- **Database Config**: Async engine + session factory for FastAPI dependency injection\n\n### Implementation Details\n\n**File Structure**:\n```\nsrc/schillinger/models/sqlalchemy/\n├── __init__.py          # Exports all models\n├── base.py              # BaseModel abstract class\n├── ui_telemetry.py      # UISession, UIInteractionEvent, UIControlMetrics\n└── parameter_telemetry.py  # ParameterChangeEvent\n\nsrc/schillinger/db/\n├── __init__.py          # Database exports\n├── config.py            # Engine configuration\n└── session.py           # Async session for FastAPI DI\n```\n\n**Base Model Pattern**:\n```python\nclass BaseModel(Base):\n    __abstract__ = True  # Don't create table\n    \n    id: Mapped[uuid.UUID] = mapped_column(\n        UUID(as_uuid=True),\n        primary_key=True,\n        default=uuid.uuid4,\n    )\n    \n    created_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True),\n        server_default=func.now(),\n        nullable=False,\n    )\n    \n    updated_at: Mapped[datetime] = mapped_column(\n        DateTime(timezone=True),\n        server_default=func.now(),\n        onupdate=func.now(),\n        nullable=False,\n    )\n```\n\n**Foreign Key Relationships**:\n```python\nclass UIInteractionEvent(BaseModel):\n    session_id: Mapped[uuid.UUID] = mapped_column(\n        UUID(as_uuid=True),\n        ForeignKey(\"ui_sessions.id\", ondelete=\"CASCADE\"),\n        nullable=False,\n        index=True,\n    )\n    \n    session: Mapped[\"UISession\"] = relationship(\n        \"UISession\",\n        back_populates=\"interaction_events\",\n    )\n```\n\n### Key Features\n\n**PostgreSQL UUID**:\n- Primary keys use `UUID(as_uuid=True)` type\n- Matches UUID v4 from Swift (sessionID, eventID)\n- Automatic UUID generation via `default=uuid.uuid4`\n\n**Timestamp Tracking**:\n- `server_default=func.now()` for created_at\n- `onupdate=func.now()` for updated_at\n- DateTime with timezone support\n\n**Cascade Deletes**:\n- `ondelete=\"CASCADE\"` on foreign keys\n- Session deletion removes all related events/metrics\n\n**Indexes**:\n- Primary key indexes automatic\n- Foreign key indexes for joins\n- Additional indexes on frequently queried fields (control_id, parameter_id, timestamp_ms)\n\n### Async Configuration\n\n**Engine Setup**:\n```python\nasync_engine = create_async_engine(\n    settings.DATABASE_URL,  # \"postgresql+asyncpg://...\"\n    echo=DEBUG,\n    pool_size=5,\n    max_overflow=10,\n    pool_pre_ping=True,  # Verify connections\n)\n```\n\n**Session Factory**:\n```python\nasync_session_maker = async_sessionmaker(\n    bind=async_engine,\n    class_=AsyncSession,\n    autocommit=False,\n    autoflush=False,\n    expire_on_commit=False,\n)\n```\n\n**FastAPI Dependency**:\n```python\nasync def get_async_session() -> AsyncGenerator[AsyncSession, None]:\n    async with async_session_maker() as session:\n        try:\n            yield session\n            await session.commit()\n        except Exception:\n            await session.rollback()\n            raise\n\n# Usage in routes:\n@app.get(\"/sessions/\")\nasync def list_sessions(session: AsyncSession = Depends(get_async_session)):\n    result = await session.execute(select(UISession))\n    return result.scalars().all()\n```\n\n### Data Model Compliance\n\nAll models match `plans/ui-telemetry-constraints-testing/data-model.md`:\n- UISession ✓\n- UIInteractionEvent ✓\n- UIControlMetrics ✓\n- ParameterChangeEvent ✓\n\n### Thread Safety\n\n- Async sessions for FastAPI concurrency\n- Pool_pre_ping for connection validation\n- Proper transaction management (commit/rollback)\n\n## When to Use This Pattern\n\nUse when you need to:\n- Store telemetry data in PostgreSQL\n- Support async/await patterns with FastAPI\n- Use UUID primary keys for distributed systems\n- Track create/update timestamps automatically\n- Cascade deletes for related records\n\n## Related Files\n\n- white_room/juce_backend/python_backend/src/schillinger/models/sqlalchemy/ - ORM models\n- white_room/juce_backend/python_backend/src/schillinger/db/ - Database configuration\n- plans/ui-telemetry-constraints-testing/data-model.md - Data model specification\n- swift_frontend/src/SwiftFrontendCore/Telemetry/ - Swift telemetry producers",
  "metadata": {
    "scope": "repository",
    "tags": [
      "python",
      "sqlalchemy",
      "postgresql",
      "async",
      "fastapi",
      "telemetry",
      "orm",
      "database"
    ],
    "confidence": 1
  },
  "timestamp": "2026-01-13T09:40:05.099Z"
}