{
  "id": "artifact-1768296615458-2qfd5qbn2",
  "type": "pattern",
  "content": "# Swift Parameter Telemetry Recording Pattern\n\n## Problem\nNeed to record user interaction metrics in Swift UI for data-driven UX optimization.\n\n## Solution: Combine-Based Parameter Telemetry\n\n### Architecture\n- **UIInteractionEvent**: Raw event data model with timestamp, delta, duration, reversal, abandon\n- **UIControlTracker**: Per-control metrics (overshoot rate, micro-adjusts, undo rate, abandon rate)\n- **UISessionTracker**: Session-level metrics (time to first sound, focus changes, control switches, dead interactions)\n\n### Implementation Details\n\n**Files**:\n- `swift_frontend/src/SwiftFrontendCore/Telemetry/UIInteractionEvent.swift` - Event data model\n- `swift_frontend/src/SwiftFrontendCore/Telemetry/UIControlTracker.swift` - Per-control tracking\n- `swift_frontend/src/SwiftFrontendCore/Telemetry/UISessionTracker.swift` - Session metrics\n\n**Integration with ParameterStore**:\n```swift\n// UIControlTracker subscribes to ParameterStore.changePublisher\nparameterStore.changePublisher\n    .sink { [weak self] change in\n        self?.handleParameterChange(change)\n    }\n    .store(in: &cancellables)\n```\n\n### Key Metrics Captured\n\n**Per-Control Metrics** (UIControlTracker):\n- `interaction_count`: Total interactions\n- `avg_adjust_time_ms`: Mean adjustment duration\n- `overshoot_rate`: Reversals / total (0-1)\n- `micro_adjust_count`: Tiny corrections (< threshold)\n- `undo_rate`: Undos / total (0-1)\n- `abandon_rate`: Focus lost mid-adjust / total (0-1)\n\n**Session Metrics** (UISessionTracker):\n- `time_to_first_sound_ms`: Launch to first audio output\n- `focus_changes`: Navigation events\n- `control_switches_per_min`: Context switches rate\n- `dead_interactions`: Input with no audible result\n\n### Interaction State Tracking\n\n**InteractionState struct** detects:\n1. **Reversals**: Direction changes during continuous adjustment (overshoot detection)\n2. **Abandon**: Focus lost before interaction commit\n3. **Duration**: Time from first change to settle\n4. **Delta**: Total parameter change magnitude\n\n```swift\npublic struct InteractionState: Sendable {\n    public var startValue: Double\n    public var currentValue: Double\n    public var direction: Double\n    public var hasReversed: Bool = false\n    public var startTime: Date\n    \n    public mutating func update(_ newValue: Double) -> InteractionState {\n        let newDirection = newValue > currentValue ? 1.0 : (newValue < currentValue ? -1.0 : 0.0)\n        \n        // Detect reversal\n        if direction != 0 && newDirection != 0 && newDirection != direction {\n            hasReversed = true\n        }\n        \n        currentValue = newValue\n        if newDirection != 0 {\n            direction = newDirection\n        }\n        \n        return self\n    }\n}\n```\n\n### Thread Safety Guarantees\n\n- `NSLock` for interaction state access\n- `NSLock` for event buffer access\n- ParameterStore callbacks on main thread (Combine)\n- Batch upload from message thread\n\n### Batch Upload\n\n**flushTelemetry()** returns:\n```swift\n[\n    \"session\": session_summary,\n    \"control_metrics\": [per_control_metrics],\n    \"interaction_events\": [raw_events]\n]\n```\n\n**JSON serialization** for Python FastAPI backend upload:\n- UIInteractionEvent.toJSON() - Single event\n- UISessionTracker.flushTelemetry() - Complete batch\n\n### SwiftUI Integration\n\n**App lifecycle tracking** (conditional compilation):\n```swift\n#if canImport(SwiftUI)\nUISessionTracker.withLifecycleTracking(\n    parameterStore: parameterStore,\n    scenePhase: $scenePhase\n)\n#endif\n```\n\n### Build Verification\n\n✅ Swift frontend compiles cleanly with no errors/warnings\n✅ Integration with existing ParameterStore @Observable pattern\n✅ Conditional SwiftUI import for non-UI targets\n\n## When to Use This Pattern\n\nUse when you need to:\n- Track user interaction patterns in SwiftUI apps\n- Compute UX metrics (overshoot, adjustment time, etc.)\n- Capture session-level user behavior\n- Enable data-driven UI optimization\n- Validate UI constraint compliance\n\n## Related Files\n\n- swift_frontend/src/SwiftFrontendCore/Stores/ParameterStore.swift - Parameter change publishers\n- plans/ui-telemetry-constraints-testing/data-model.md - Data model specification\n- juce_backend/src/frontend/telemetry/ParameterTelemetryRecorder.h - JUCE backend counterpart",
  "metadata": {
    "scope": "repository",
    "tags": [
      "swift",
      "telemetry",
      "ui",
      "combine",
      "parameter-tracking",
      "ux-metrics",
      "interaction-tracking"
    ],
    "confidence": 1
  },
  "timestamp": "2026-01-13T09:30:15.458Z"
}