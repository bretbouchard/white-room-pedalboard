{
  "id": "artifact-1768298353034-38bb7lb23",
  "type": "pattern",
  "content": "# iOS App Audio Issue - Deep Dive Analysis\n\n## Problem\niOS app says it's generating notes but no sound is heard during playback.\n\n## Complete Audio Flow Trace\n\n### 1. Swift Frontend (JUCEEngine.swift)\n- **play()** (line 687) ‚Üí Calls `sch_engine_transport()` with PLAY action\n- **startRenderer()** (line 752) ‚Üí Starts DispatchSourceTimer (100ms interval)\n- **renderEvents()** (line 784) ‚Üí Called every 100ms, calls `sch_engine_get_events()`\n- **For each event** ‚Üí Calls `sch_engine_send_note_on()` or `sch_engine_send_note_off()`\n\n### 2. SchillingerEngineCore FFI (schillinger_ffi.cpp)\n- **sch_engine_transport()** (line 459) ‚Üí Calls `e->core->transport()`\n- **sch_engine_get_events()** (line 520) ‚Üí Calls `e->core->getEvents()` and converts to C structs\n\n### 3. EngineCore C++ (EngineCoreImpl.cpp)\n- **transport()** ‚Üí Updates `state_.transport.isPlaying`\n- **getEvents()** (line 633) ‚Üí Only generates events if `isPlaying == true`\n- **generateV1Events()** (line 793) ‚Üí Generates MIDI events using rhythm patterns\n  - Gets roles: `getRoles_unlocked()` (line 806)\n  - Checks if role isActive (line 856) ‚Üí **Skips inactive roles**\n  - Uses V1 grammar or pattern-based generation (lines 862-874)\n  - Calls `emitNoteEvents()` to create NoteOn/NoteOff events (line 872)\n- **emitNoteEvents()** (line 1104) ‚Üí Creates MusicalEvent with note, velocity, channel\n\n### 4. Audio Bridge (audio_only_bridge.mm)\n- **sch_engine_send_note_on()** (line 828) ‚Üí Calls `processor->triggerNoteOn()`\n- **RealTimeAudioProcessor::triggerNoteOn()** (line 284) ‚Üí Calls `instrument->handleEvent()`\n- **LocalGalPureDSP::handleEvent()** ‚Üí Processes NOTE_ON event\n- **render callback** (line 485) ‚Üí Calls `processor->process()` ‚Üí calls `instrument->process()`\n\n## Key Debug Points\n\n### Existing Logging\n1. **JUCEEngine.swift** (line 811): `\"üéØ [DEBUG] Requesting events for tick range...\"`\n2. **JUCEEngine.swift** (line 826): `\"‚ö†Ô∏è sch_engine_get_events failed: ...\"`\n3. **JUCEEngine.swift** (line 848): `\"üéµ Received \\(eventBatch.count) events...\"`\n4. **JUCEEngine.swift** (line 868): Event detail logging with note/vel/channel\n5. **EngineCoreImpl.cpp** (line 871): `\"[Role %zu] Using V1 grammar generation...\"`\n6. **EngineCoreImpl.cpp** (line 881-899): Filter debug logging\n7. **audio_only_bridge.mm** (line 302): `\"RealTimeAudioProcessor: Channel X Note ON...\"`\n8. **audio_only_bridge.mm** (line 488): Render callback logging\n\n### Missing Diagnostic Points\n1. **Is renderer running?** - No log when DispatchSourceTimer fires\n2. **Is transport.isPlaying true?** - Need to verify transport state\n3. **Are roles active?** - Need to verify isActive flag\n4. **Are patterns set?** - createDefaultSong creates EMPTY song\n5. **Is audio engine running?** - Need to verify isPlaying flag in iOSAudioEngine\n\n## Likely Root Causes (Priority Order)\n\n### 1. **Renderer Not Starting** (MOST LIKELY)\n- DispatchSourceTimer may not be firing\n- Check if `startRenderer()` is actually being called\n- No \"Event renderer started\" log would confirm\n\n### 2. **Transport State Not Syncing**\n- `isPlaying` might be false in C++ even after play() call\n- Callback not firing or state not being set\n- Check line 640 in EngineCoreImpl.cpp: only generates if `isPlaying`\n\n### 3. **Roles Inactive**\n- If mute=1, isActive=false, events won't generate (line 856-859)\n- Check role configuration from Swift (line 452 in JUCEEngine.swift)\n\n### 4. **Audio Engine Not Running**\n- `isPlaying` flag in iOSAudioEngine (audio_only_bridge.mm line 373)\n- Render callback outputs silence if not playing (line 492-497)\n\n### 5. **Instrument Not Processing**\n- LocalGalPureDSP not handling events\n- Need to check if events reach triggerNoteOn()\n\n## Diagnostic Plan\n\n1. **Add renderer lifecycle logging**:\n   - Log when timer fires in renderEvents()\n   - Log DispatchSourceTimer creation status\n\n2. **Verify transport state**:\n   - Log `isPlaying` value in getEvents()\n   - Add log in transport() callback\n\n3. **Verify role activation**:\n   - Log each role's isActive state\n   - Log \"Role INACTIVE - skipping\" message\n\n4. **Add audio path logging**:\n   - Log each note reaching triggerNoteOn()\n   - Log render callback status\n\n5. **Add test note on audio start**:\n   - Already exists at line 527-528 in audio_only_bridge.mm\n   - Should hear a single C4 note when audio starts\n\n## Test Notes\n- Test note in audio_only_bridge.mm (line 527-528) triggers C4 when audio starts\n- If test note is heard, audio path is working\n- If test note NOT heard, issue is in audio engine initialization",
  "metadata": {
    "scope": "repository",
    "tags": [
      "ios",
      "audio",
      "debug",
      "schillinger-engine-core",
      "juce"
    ],
    "confidence": 0.9
  },
  "timestamp": "2026-01-13T09:59:13.034Z"
}