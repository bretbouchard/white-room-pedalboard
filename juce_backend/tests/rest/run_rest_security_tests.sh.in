#!/bin/bash

# REST API Security Test Runner
# This script runs comprehensive security tests for the REST API framework

set -e  # Exit on any error

echo "ðŸ”’ REST API Security Test Suite"
echo "================================"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
TEST_BINARY="@CMAKE_CURRENT_BINARY_DIR@/RestSecurityComprehensiveTests"
COVERAGE_DIR="@CMAKE_CURRENT_BINARY_DIR@/rest_security_coverage_report"
VALGRIND_SUPPRESSIONS="@CMAKE_CURRENT_SOURCE_DIR@/valgrind.supp"

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if test binary exists
if [ ! -f "$TEST_BINARY" ]; then
    print_error "Test binary not found: $TEST_BINARY"
    print_status "Please build the tests first with: make RestSecurityComprehensiveTests"
    exit 1
fi

# Function to run a specific test category
run_test_category() {
    local category="$1"
    local description="$2"

    print_status "Running $description..."

    if "$TEST_BINARY" --gtest_filter="$category" --gtest_output=xml; then
        print_success "$description passed"
        return 0
    else
        print_error "$description failed"
        return 1
    fi
}

# Function to run performance tests
run_performance_tests() {
    print_status "Running Performance Tests..."

    # Run performance tests with timing
    local start_time=$(date +%s.%N)

    if "$TEST_BINARY" --gtest_filter="*Performance*" --gtest_output=xml; then
        local end_time=$(date +%s.%N)
        local duration=$(echo "$end_time - $start_time" | bc)

        print_success "Performance tests completed in ${duration}s"
        return 0
    else
        print_error "Performance tests failed"
        return 1
    fi
}

# Function to run vulnerability tests
run_vulnerability_tests() {
    print_status "Running Security Vulnerability Tests..."

    # Test for common vulnerabilities
    local vulnerability_categories="*SqlInjection*:*Xss*:*RateLimit*:*InputValidation*"

    if "$TEST_BINARY" --gtest_filter="$vulnerability_categories" --gtest_output=xml; then
        print_success "Security vulnerability tests passed"
        return 0
    else
        print_error "Security vulnerability tests failed"
        return 1
    fi
}

# Function to run integration tests
run_integration_tests() {
    print_status "Running Integration Tests..."

    if "$TEST_BINARY" --gtest_filter="*Integration*" --gtest_output=xml; then
        print_success "Integration tests passed"
        return 0
    else
        print_error "Integration tests failed"
        return 1
    fi
}

# Function to run thread safety tests
run_thread_safety_tests() {
    print_status "Running Thread Safety Tests..."

    if "$TEST_BINARY" --gtest_filter="*Thread*" --gtest_output=xml; then
        print_success "Thread safety tests passed"
        return 0
    else
        print_error "Thread safety tests failed"
        return 1
    fi
}

# Function to run memory leak detection
run_memory_tests() {
    if command -v valgrind &> /dev/null; then
        print_status "Running Memory Leak Detection..."

        local valgrind_cmd="valgrind"
        local valgrind_opts="--leak-check=full --show-leak-kinds=all --track-origins=yes --error-exitcode=1"

        if [ -f "$VALGRIND_SUPPRESSIONS" ]; then
            valgrind_opts="$valgrind_opts --suppressions=$VALGRIND_SUPPRESSIONS"
        fi

        # Run a subset of tests with valgrind (to avoid excessive runtime)
        if $valgrind_cmd $valgrind_opts "$TEST_BINARY" --gtest_filter="*RateLimit*:*JsonParser*" --gtest_output=xml; then
            print_success "Memory leak detection passed"
            return 0
        else
            print_error "Memory leak detection failed"
            return 1
        fi
    else
        print_warning "Valgrind not found, skipping memory leak detection"
        return 0
    fi
}

# Function to generate coverage report
generate_coverage() {
    if command -v lcov &> /dev/null && command -v genhtml &> /dev/null; then
        print_status "Generating Code Coverage Report..."

        # Capture coverage data
        lcov --capture --directory . --output-file rest_security_coverage.info

        # Remove system and test files from coverage
        lcov --remove rest_security_coverage.info '/usr/*' --output-file rest_security_coverage.info
        lcov --remove rest_security_coverage.info '*/test*' --output-file rest_security_coverage.info
        lcov --remove rest_security_coverage.info '*/tests/*' --output-file rest_security_coverage.info

        # Generate HTML report
        genhtml rest_security_coverage.info --output-directory "$COVERAGE_DIR"

        if [ -d "$COVERAGE_DIR" ]; then
            print_success "Coverage report generated at: $COVERAGE_DIR/index.html"

            # Show coverage summary
            if command -v lcov &> /dev/null; then
                lcov --summary rest_security_coverage.info
            fi
        else
            print_error "Failed to generate coverage report"
            return 1
        fi
    else
        print_warning "lcov/genhtml not found, skipping coverage report generation"
        return 0
    fi
}

# Function to run load test
run_load_test() {
    print_status "Running Load Test (1000 requests)..."

    # Simple load test using the test binary
    local load_test_iterations=10
    local requests_per_iteration=100

    for ((i=1; i<=load_test_iterations; i++)); do
        print_status "Load test iteration $i/$load_test_iterations..."

        if "$TEST_BINARY" --gtest_filter="*Performance*" --gtest_repeat=$requests_per_iteration --gtest_break_on_failure; then
            print_success "Load test iteration $i completed"
        else
            print_error "Load test iteration $i failed"
            return 1
        fi
    done

    print_success "Load test completed successfully"
    return 0
}

# Main execution
main() {
    local failed_tests=0
    local total_tests=0

    # Parse command line arguments
    case "${1:-all}" in
        "unit")
            run_test_category "*JsonParser*:*RateLimit*:*InputValidator*" "Unit Tests"
            ;;
        "integration")
            run_integration_tests
            ;;
        "performance")
            run_performance_tests
            ;;
        "vulnerability")
            run_vulnerability_tests
            ;;
        "memory")
            run_memory_tests
            ;;
        "coverage")
            generate_coverage
            ;;
        "load")
            run_load_test
            ;;
        "thread")
            run_thread_safety_tests
            ;;
        "all"|*)
            print_status "Running complete test suite..."

            # Run all test categories
            run_test_category "*JsonParser*" "JSON Parser Tests" || ((failed_tests++))
            ((total_tests++))

            run_test_category "*RateLimit*" "Rate Limiting Tests" || ((failed_tests++))
            ((total_tests++))

            run_test_category "*InputValidator*" "Input Validation Tests" || ((failed_tests++))
            ((total_tests++))

            run_vulnerability_tests || ((failed_tests++))
            ((total_tests++))

            run_integration_tests || ((failed_tests++))
            ((total_tests++))

            run_performance_tests || ((failed_tests++))
            ((total_tests++))

            run_memory_tests || ((failed_tests++))
            ((total_tests++))

            # Optional: generate coverage if requested
            if [ "${2:-}" = "coverage" ]; then
                generate_coverage
            fi
            ;;
    esac

    # Print summary
    echo
    echo "ðŸ”’ Test Suite Summary"
    echo "===================="

    if [ $failed_tests -eq 0 ]; then
        print_success "All tests passed! ($((total_tests - failed_tests))/$total_tests categories)"
        echo
        print_success "ðŸ›¡ï¸ REST API Security Framework is ready for deployment!"
        exit 0
    else
        print_error "Some tests failed ($failed_tests/$total_tests categories)"
        echo
        print_error "âŒ REST API Security Framework needs attention before deployment"
        exit 1
    fi
}

# Show usage if requested
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat << EOF
Usage: $0 [CATEGORY] [OPTIONS]

Categories:
  unit          Run unit tests for individual components
  integration   Run integration tests
  performance   Run performance benchmarks
  vulnerability Run security vulnerability tests
  memory        Run memory leak detection
  coverage      Generate code coverage report
  load          Run load tests
  thread        Run thread safety tests
  all           Run all tests (default)

Examples:
  $0                    # Run all tests
  $0 unit                # Run only unit tests
  $0 performance         # Run performance tests
  $0 all coverage        # Run all tests and generate coverage

Environment Variables:
  REST_SECURITY_LOG_LEVEL  Set logging level (debug, info, warn, error)
  REST_SECURITY_CONFIG     Path to custom configuration file

EOF
    exit 0
fi

# Run main function with all arguments
main "$@"