# tvOS SDK Embedding Handoff

**Date:** December 31, 2025
**Status:** üü° READY FOR IMPLEMENTATION
**Owner:** Platform Team (Swift) + SDK Team (TypeScript) + DSP Team (JUCE)

---

## Executive Summary

Embed the TypeScript Schillinger SDK into tvOS using JavaScriptCore, with a bullet-proof Swift bridge that ensures:
- **Zero audio glitches** (JSCore never on audio thread)
- **100% determinism** (seeded RNG, no timers)
- **Record/replay debugging** (golden test fixtures)
- **Validation wall** (no silent drift)

---

## Core Architecture

```
Swift UI ‚Üí SDK Queue (serial) ‚Üí JSCore (SDK) ‚Üí Plan Ring Buffer ‚Üí JUCE Audio Thread
```

**Key Principle:** JSCore NEVER runs on audio thread.

---

## 1. SDK Bundle Build (TypeScript)

### ESBuild Configuration

```bash
# frontend/build-tvos-sdk.sh
npx esbuild src/schillinger/core/sdk-entry.ts \
  --bundle \
  --platform=neutral \
  --target=es2020 \
  --format=iife \
  --global-name=SchillingerSDK \
  --outfile=../platform/tvos/SchillingerSDK.bundle.js
```

### Constraints (NON-NEGOTIABLE)

- ‚úÖ ES2020 output only
- ‚úÖ No Node APIs (fs, path, crypto, Buffer, process)
- ‚úÖ No dynamic imports
- ‚úÖ No eval/new Function
- ‚úÖ No timers inside SDK
- ‚úÖ SeededRNG only
- ‚úÖ Synchronous only (no async/await)
- ‚úÖ No fetch/XMLHttpRequest

### Deliverables

```
platform/tvos/
‚îú‚îÄ‚îÄ SchillingerSDK.bundle.js          # Single JS bundle
‚îî‚îÄ‚îÄ SchillingerSDK.bundle.js.sha256   # Integrity hash
```

---

## 2. Bridge API (6 Methods Only)

### Public Contract

1. **init(config)** ‚Üí `{ sessionId, sdkBuildHash, schemaVersion }`
2. **applyIR(sessionId, irDelta)** ‚Üí `{ ok, irHash }`
3. **plan(sessionId, window)** ‚Üí `{ ok, planHash, plan }`
4. **explain(sessionId, query)** ‚Üí `{ ok, explanations[] }`
5. **snapshot(sessionId)** ‚Üí `{ ok, snapshot }`
6. **validate(ir)** ‚Üí `{ ok, isValid, errors[], warnings[] }`

### Message Format

**Request:**
```json
{
  "op": "plan",
  "id": "req-123",
  "payload": { "sessionId": "session-abc", "window": {"from": 0, "to": 48000} }
}
```

**Response:**
```json
{
  "id": "req-123",
  "ok": true,
  "result": { "planHash": "abc123", "plan": {...} }
}
```

---

## 3. Threading Model

**RULE:** JSCore never on audio thread. Ever.

```
Swift UI Thread:
  ‚Ä¢ User input ‚Üí enqueue applyIR
  ‚Ä¢ Call sdk.plan() on SDK queue (serial dispatch queue)
  ‚Ä¢ Write result to Plan Ring Buffer (lock-free)

JUCE Audio Thread:
  ‚Ä¢ Read from Plan Ring Buffer (atomic pointer)
  ‚Ä¢ Swap to new plan if available
  ‚Ä¢ Use cached plan (never blocks)
```

If SDK stalls, JUCE keeps playing last valid plan.

---

## 4. Determinism Hardening

### Every Plan Request Includes

- `sessionSeed` - RNG seed
- `graphInstanceId` - Graph instance ID
- `window.from`, `window.to` - Time window
- `schemaVersion` - Schema version
- `sdkBuildHash` - SDK build hash

### SDK Must Return

- `planHash` - SHA-256 of plan IR
- `irHash` - SHA-256 of current IR state

### No Hidden State

- All state in `sessionId` as explicit IR
- No global mutable variables
- All randomness from `SeededRNG(seed + offset)`

---

## 5. Validation Wall

### SDK-Side Validation

Implement in TypeScript SDK:

- JSON schema validation
- ID uniqueness per namespace
- Acyclic graph check
- PatternIR has ProcessIR
- Constraint resolution produces stable winners
- Scene changes don't mutate SongGraphIR

**Fail fast:** Return error code + message + failing IR path

---

## 6. Test Suite

### Golden Determinism Tests

Record request/response envelopes in:
```
tests/schillinger/fixtures/
‚îú‚îÄ‚îÄ init_sequence.request.json
‚îú‚îÄ‚îÄ init_sequence.response.json
‚îú‚îÄ‚îÄ apply_ir_delta.request.json
‚îú‚îÄ‚îÄ apply_ir_delta.response.json
‚îî‚îÄ‚îÄ generate_plan_window1.request.json + response.json
```

Test: Load request ‚Üí execute ‚Üí compare to golden ‚Üí assert hashes match

### JSCore Parity Tests

Run same fixtures in Node.js and JSCore ‚Üí assert outputs identical

### Long-Run Soak Test

Replay 20-minute envelope log ‚Üí assert no drift, no memory leaks

---

## 7. File Structure

```
platform/tvos/
‚îú‚îÄ‚îÄ SchillingerSDK.bundle.js           # Generated by esbuild
‚îú‚îÄ‚îÄ SchillingerSDK.bundle.js.sha256    # Integrity hash
‚îú‚îÄ‚îÄ SchillingerBridge.swift             # Swift bridge
‚îú‚îÄ‚îÄ SchillingerPlanCache.h              # Lock-free plan cache (C++)
‚îú‚îÄ‚îÄ SchillingerIntegration.cpp          # JUCE integration
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ SchillingerGoldenTest.cpp       # Golden tests
‚îÇ   ‚îú‚îÄ‚îÄ JSCoreParityTest.cpp           # Parity tests
‚îÇ   ‚îî‚îÄ‚îÄ fixtures/*.json                # Test fixtures
‚îî‚îÄ‚îÄ TVOS_SDK_EMBEDDING_HANDOFF.md      # This document

frontend/src/schillinger/core/
‚îú‚îÄ‚îÄ sdk-entry.ts                         # SDK entry point
‚îú‚îÄ‚îÄ random/SeededRNG.ts                 # Deterministic RNG
‚îú‚îÄ‚îÄ session/SessionManager.ts           # Session state
‚îú‚îÄ‚îÄ planning/PlanGenerator.ts           # Plan generation
‚îú‚îÄ‚îÄ explain/ExplainabilityEngine.ts     # Explainability
‚îî‚îÄ‚îÄ validation/IRValidator.ts            # Validation wall
```

---

## 8. Build Script

```bash
#!/bin/bash
# frontend/build-tvos-sdk.sh

echo "Building Schillinger SDK for tvOS..."

cd frontend

npx esbuild src/schillinger/core/sdk-entry.ts \
  --bundle \
  --platform=neutral \
  --target=es2020 \
  --format=iife \
  --global-name=SchillingerSDK \
  --outfile=../platform/tvos/SchillingerSDK.bundle.js \
  --banner="// SchillingerSDK v1.0.0 | Built: $(date)"

# Generate SHA-256 hash
shasum -a 256 ../platform/tvos/SchillingerSDK.bundle.js > \
  ../platform/tvos/SchillingerSDK.bundle.js.sha256

echo "SHA-256: $(cat ../platform/tvos/SchillingerSDK.bundle.js.sha256)"
echo "‚úÖ SDK bundle built successfully!"
```

---

## 9. Milestones

### Milestone 1 (1-2 days)
- [ ] Bundle loads in JSCore
- [ ] init/applyIR/plan works
- [ ] IR validation returns useful errors

### Milestone 2 (2-3 days)
- [ ] JUCE consumes plan results
- [ ] Ring buffer / atomic plan swap works
- [ ] Audio never blocks

### Milestone 3 (2-3 days)
- [ ] Record/replay logs
- [ ] Golden tests in CI (Node + JSCore)

### Milestone 4 (2-3 days)
- [ ] Stress: multi-song overlap
- [ ] Scene switching
- [ ] Soak tests (20 minutes)

---

## 10. Anti-Patterns (DO NOT DO)

‚ùå **Never** call JSCore from JUCE audio thread
‚ùå **Never** let Swift "fix up" IR
‚ùå **Never** rely on system RNG, time, or timers
‚ùå **Never** allow partial/missing fields in IR
‚ùå **Never** add "clever" caching without hashes

---

## 11. Success Metrics

‚úÖ **Complete When:**
1. SDK bundle loads in JSCore
2. Swift bridge exposes 6 methods
3. JUCE consumes plans atomically
4. Audio never blocks on SDK
5. Golden tests pass (100%)
6. JSCore parity tests pass
7. Determinism lock enforced
8. IR validation wall working
9. Bundle integrity verified
10. No memory leaks

---

**Status:** üü° READY FOR IMPLEMENTATION
**Priority:** HIGH (enables Schillinger on tvOS)
**Estimated Effort:** 5-7 days implementation + 2-3 days testing
