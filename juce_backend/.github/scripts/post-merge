#!/bin/bash

#==============================================================================
# Git Post-Merge Hook: Instrument Subtree Split
#
# Automatically splits and pushes instrument changes after merges.
# Useful when pulling changes from remote.
#
# To enable: chmod +x .git/hooks/post-merge
# To disable: chmod -x .git/hooks/post-merge
#==============================================================================

# Skip if environment variable set
if [[ "$SKIP_SUBTREE_SPLIT" == "true" ]]; then
    exit 0
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
SPLIT_SCRIPT="$PROJECT_ROOT/.github/scripts/split_instruments.sh"

# Check if split script exists
if [[ ! -f "$SPLIT_SCRIPT" ]]; then
    echo "âš ï¸  Subtree split script not found: $SPLIT_SCRIPT"
    exit 0
fi

# Check if GH token is available
if [[ -z "$GH_TOKEN" ]]; then
    # Try GitHub CLI
    if command -v gh &> /dev/null; then
        GH_TOKEN=$(gh auth token 2>/dev/null)
    fi

    # Try to load from .env file
    if [[ -z "$GH_TOKEN" && -f "$PROJECT_ROOT/.env" ]]; then
        source "$PROJECT_ROOT/.env"
    fi

    if [[ -z "$GH_TOKEN" ]]; then
        echo "âš ï¸  GH_TOKEN not set - skipping subtree split"
        echo "   Set GH_TOKEN in your environment or .env file"
        echo "   Or use: gh auth login (GitHub CLI)"
        exit 0
    fi
fi

# Get list of merged commits
MERGED_COMMITS=$(git log --merges --pretty=format:%P HEAD -1 | awk '{print $1}')

if [[ -z "$MERGED_COMMITS" ]]; then
    # No merge commits detected
    exit 0
fi

echo "ðŸ”„ Running subtree split after merge..."

# Run full split for all instruments after merge
"$SPLIT_SCRIPT" 2>&1 | grep -E "(INFO|SUCCESS|ERROR|WARNING)" || true

echo "âœ… Subtree split complete"
exit 0
