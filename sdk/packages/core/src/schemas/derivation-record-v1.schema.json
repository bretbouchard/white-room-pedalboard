{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://schemas.schillinger.sdk/v1/derivation-record",
  "title": "DerivationRecord_v1",
  "description": "Immutable trace of realization process. Explains how every note was generated from theory parameters.",
  "type": "object",
  "required": [
    "derivationId",
    "sourceSongId",
    "seed",
    "executionOrder",
    "outputs",
    "constraintsApplied"
  ],
  "properties": {
    "derivationId": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this derivation"
    },
    "sourceSongId": {
      "type": "string",
      "format": "uuid",
      "description": "SchillingerSong.songId that was realized"
    },
    "seed": {
      "type": "integer",
      "minimum": 0,
      "maximum": 4294967295,
      "description": "PRNG seed used for realization (32-bit)"
    },
    "executionOrder": {
      "type": "array",
      "description": "System IDs in execution order",
      "items": {
        "type": "string",
        "format": "uuid"
      }
    },
    "outputs": {
      "type": "array",
      "description": "Outputs from each system",
      "items": {
        "type": "object",
        "required": ["systemId", "outputType", "noteIds", "parameters", "constraints"],
        "properties": {
          "systemId": {
            "type": "string",
            "format": "uuid",
            "description": "Source system that generated this output"
          },
          "outputType": {
            "type": "string",
            "enum": ["rhythm", "melody", "harmony", "form", "orchestration"],
            "description": "Type of output"
          },
          "noteIds": {
            "type": "array",
            "description": "Notes generated by this system",
            "items": {
              "type": "string",
              "format": "uuid"
            }
          },
          "parameters": {
            "type": "object",
            "description": "System parameters used during realization"
          },
          "constraints": {
            "type": "array",
            "description": "Constraint IDs applied to this system",
            "items": {
              "type": "string",
              "format": "uuid"
            }
          }
        }
      }
    },
    "constraintsApplied": {
      "type": "array",
      "description": "Record of all constraint applications",
      "items": {
        "type": "object",
        "required": ["constraintId", "systemId", "satisfied", "details"],
        "properties": {
          "constraintId": {
            "type": "string",
            "format": "uuid"
          },
          "systemId": {
            "type": "string",
            "format": "uuid",
            "description": "System this constraint was applied to"
          },
          "satisfied": {
            "type": "boolean",
            "description": "Whether constraint was satisfied"
          },
          "details": {
            "type": "string",
            "description": "Human-readable explanation of constraint application"
          }
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "description": "Derivation record for simple rhythm realization",
      "derivationId": "6ba7b810-9dad-11d1-80b4-00c04fd430c8",
      "sourceSongId": "550e8400-e29b-41d4-a716-446655440000",
      "seed": 12345,
      "executionOrder": [
        "7f9b8e10-9dad-11d1-80b4-00c04fd430c8",
        "8ba09020-9dad-11d1-80b4-00c04fd430c8"
      ],
      "outputs": [
        {
          "systemId": "7f9b8e10-9dad-11d1-80b4-00c04fd430c8",
          "outputType": "rhythm",
          "noteIds": [
            "9ca1a030-9dad-11d1-80b4-00c04fd430c8",
            "adb2b140-9dad-11d1-80b4-00c04fd430c8",
            "bec3c250-9dad-11d1-80b4-00c04fd430c8",
            "cfd4d360-9dad-11d1-80b4-00c04fd430c8"
          ],
          "parameters": {
            "generators": [
              {
                "period": 3,
                "phase": 0,
                "weight": 1.0
              },
              {
                "period": 4,
                "phase": 0,
                "weight": 1.0
              }
            ],
            "resultantMethod": "interference",
            "densityMin": 2,
            "densityMax": 8
          },
          "constraints": [
            "7f9b8e10-9dad-11d1-80b4-00c04fd430c8",
            "8ba09020-9dad-11d1-80b4-00c04fd430c8"
          ]
        },
        {
          "systemId": "8ba09020-9dad-11d1-80b4-00c04fd430c8",
          "outputType": "orchestration",
          "noteIds": [
            "9ca1a030-9dad-11d1-80b4-00c04fd430c8",
            "adb2b140-9dad-11d1-80b4-00c04fd430c8",
            "bec3c250-9dad-11d1-80b4-00c04fd430c8",
            "cfd4d360-9dad-11d1-80b4-00c04fd430c8"
          ],
          "parameters": {
            "voiceAssignments": {
              "primary": {
                "voiceId": "9da1a030-9dad-11d1-80b4-00c04fd430c8",
                "roleId": "primary-role"
              }
            }
          },
          "constraints": []
        }
      ],
      "constraintsApplied": [
        {
          "constraintId": "7f9b8e10-9dad-11d1-80b4-00c04fd430c8",
          "systemId": "7f9b8e10-9dad-11d1-80b4-00c04fd430c8",
          "satisfied": true,
          "details": "Density constraint satisfied: 4 attacks per measure (within 2-8 range)"
        },
        {
          "constraintId": "8ba09020-9dad-11d1-80b4-00c04fd430c8",
          "systemId": "7f9b8e10-9dad-11d1-80b4-00c04fd430c8",
          "satisfied": true,
          "details": "Quantization constraint satisfied: all notes on 0.25 beat grid"
        }
      ]
    }
  ]
}
